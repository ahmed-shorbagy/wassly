rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserType() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null ? userDoc.data.userType : null;
    }
    
    // Admin access: 
    // 1. Authenticated users with admin userType
    // 2. Anonymous users (for admin app - app signs in anonymously automatically)
    // NOTE: Only the admin app uses anonymous auth. Other apps use regular authentication.
    // Ensure admin app is distributed securely to trusted personnel only.
    function isAdmin() {
      if (!isAuthenticated()) return false;
      
      // Check if anonymous user (admin app)
      let provider = request.auth.token.firebase.sign_in_provider;
      if (provider == 'anonymous') return true;
      
      // Check if authenticated user with admin type
      let userType = getUserType();
      return userType != null && userType == 'admin';
    }
    
    function isDriver() {
      return isAuthenticated() && getUserType() == 'driver';
    }
    
    function isRestaurantOwner() {
      return isAuthenticated() && getUserType() == 'restaurant';
    }
    
    function isCustomer() {
      return isAuthenticated() && getUserType() == 'customer';
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone can read their own profile
      allow read: if isOwner(userId);
      // Users can create their own profile during signup
      allow create: if isOwner(userId);
      // Users can update their own profile
      allow update: if isOwner(userId);
      // Only admins can delete users
      allow delete: if isAdmin();
      // Admins can read all users
      allow read: if isAdmin();
    }
    
    // Restaurants collection
    match /restaurants/{restaurantId} {
      // Everyone can read restaurant information
      allow read: if true;
      // Only admins can create restaurants
      allow create: if isAdmin();
      // Restaurant owners can update their own restaurant
      allow update: if isAdmin() || 
        (isRestaurantOwner() && resource.data.ownerId == request.auth.uid);
      // Only admins can delete restaurants
      allow delete: if isAdmin();
    }
    
    // Products collection
    match /products/{productId} {
      // Everyone can read products
      allow read: if true;
      // Admins can manage all products
      allow write: if isAdmin();
      // Restaurant owners can manage their own products
      allow create, update, delete: if isRestaurantOwner() && 
        exists(/databases/$(database)/documents/restaurants/$(request.resource.data.restaurantId)) &&
        get(/databases/$(database)/documents/restaurants/$(request.resource.data.restaurantId)).data.ownerId == request.auth.uid;
    }
    
    // Orders collection
    match /orders/{orderId} {
      // Customers can read their own orders
      allow read: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.driverId == request.auth.uid ||
        isAdmin()
      );
      // Restaurant owners can read orders for their restaurant
      allow read: if isRestaurantOwner() && 
        exists(/databases/$(database)/documents/restaurants/$(resource.data.restaurantId)) &&
        get(/databases/$(database)/documents/restaurants/$(resource.data.restaurantId)).data.ownerId == request.auth.uid;
      // Drivers can read available orders (status = ready, no driver assigned)
      allow read: if isDriver() && (resource.data.status == 'ready' || resource.data.driverId == request.auth.uid);
      // Customers can create orders
      allow create: if isCustomer() && request.resource.data.customerId == request.auth.uid;
      // Customers can cancel their own orders (status update to cancelled)
      allow update: if isCustomer() && 
        resource.data.customerId == request.auth.uid && 
        request.resource.data.status == 'cancelled' &&
        resource.data.status == 'pending';
      // Restaurant owners can update order status
      allow update: if isRestaurantOwner() && 
        exists(/databases/$(database)/documents/restaurants/$(resource.data.restaurantId)) &&
        get(/databases/$(database)/documents/restaurants/$(resource.data.restaurantId)).data.ownerId == request.auth.uid;
      // Drivers can update orders they're assigned to
      allow update: if isDriver() && (
        resource.data.driverId == request.auth.uid ||
        (resource.data.status == 'ready' && request.resource.data.driverId == request.auth.uid)
      );
      // Admins have full access
      allow read, write: if isAdmin();
    }
    
    // Drivers collection
    match /drivers/{driverId} {
      // Drivers can read their own data
      allow read: if isOwner(driverId) || isAdmin();
      // Only admins can create/update/delete drivers
      allow write: if isAdmin();
      // Drivers can update their online status
      allow update: if isOwner(driverId) && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isOnline', 'updatedAt']);
    }
    
    // Cart collection (subcollection under users)
    match /cart/{userId}/items/{itemId} {
      allow read, write: if isOwner(userId);
    }
    
    // Favorites collection
    match /favorites/{favoriteId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Delivery addresses
    match /delivery_addresses/{addressId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Food categories (read by everyone, write by admins)
    match /food_categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Market products
    match /market_products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Startup ads
    match /startup_ads/{adId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Banner ads
    match /banner_ads/{bannerId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}

